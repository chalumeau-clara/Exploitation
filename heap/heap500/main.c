#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>
#include <errno.h>
#include <fcntl.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <arpa/inet.h>
#include <inttypes.h>

typedef void (*t_hdl_client)(void);

#define PORT 9000
#define IPADDR "0.0.0.0"

void setup_serv(t_hdl_client handle_client) {
    int sockfd;
    struct sockaddr_in self;
    int clientfd;
    struct sockaddr_in client_addr;
    int addrlen=sizeof(client_addr);
    pid_t pid;

    if ( (sockfd = socket(AF_INET, SOCK_STREAM, 0)) < 0 )
        exit(errno);

    memset(&self, 0, sizeof(self));
    self.sin_family = AF_INET;
    self.sin_port = htons(PORT);
    self.sin_addr.s_addr = inet_addr(IPADDR);

    if ( bind(sockfd, (struct sockaddr*)&self, sizeof(self)) != 0 )
        exit(errno);

    if ( listen(sockfd, 20) != 0 )
        exit(errno);

    while (1)
    {
        clientfd = accept(sockfd, (struct sockaddr*)&client_addr, &addrlen);

        pid = fork();

        if (!pid)
        {
            dup2(clientfd, 0);
            dup2(clientfd, 1);
            dup2(clientfd, 2);
            handle_client();
            close(clientfd);
            return;
        }
    }

    close(sockfd);
    return;
}

/* In case we use inetd */
#define PRINTF(...) do { \
  printf(__VA_ARGS__); fflush(stdout); \
} while (0)

typedef enum
{
    GlobalPalet = 1,
    SetGlobalPalet,
    CreatePalet,
    DestroyPalet,
    GetFlag,
    Exit,
} Action;


uint64_t get_value(void) {
    char buf[30];
    uint64_t res = 0;

    while (1)
    {
        PRINTF("Enter value: ");
        fgets(buf, sizeof(buf), stdin);
        if (sscanf(buf, "%" SCNu64, &res))
            return res;
    }

    return 0;
}

static Action get_action(void)
{
    char choice[10];
    Action action;

    while (1)
    {
        PRINTF("Action: ");
        fgets(choice, sizeof(choice), stdin);
        if (sscanf(choice, "%u", &action))
            return action;
    }
}

int         is_admin = 0;
uint64_t    *glb_palette = NULL;
#define     MAX_PALETTE_SIZE 0x1000
#define     NB_STD 0x10
uint64_t    *std_palette[NB_STD] = {NULL};


void get_flag() {
    if (!is_admin) {
        PRINTF("Your are not admin!\n");
    }
    else {
        char buf[0x1000];

        int fd = open("flag", O_RDONLY);
        int sz = read(fd, buf, sizeof(buf));

        PRINTF("%s\n", buf);
        close(fd);
    }
}

void global_palet() {
    if (glb_palette) {
        PRINTF("Global palette already exist!\n");
        return;
    }

    PRINTF("Enter number of color in palette:\n");
    uint64_t sz = get_value();

    if (sz > MAX_PALETTE_SIZE) {
        PRINTF("Too Big!\n");
        return;
    }

    glb_palette = malloc(sz * sizeof(uint64_t));

    PRINTF("[DEBUG] Palette allocated at %p\n", glb_palette);
}

void set_glb_palet() {
    if (!glb_palette) {
        PRINTF("Global palette do not exist!\n");
        return;
    }

    PRINTF("Enter index to set in palette:\n");
    uint64_t idx = get_value();

    if (idx > MAX_PALETTE_SIZE) {
        PRINTF("Idx is too big!");
        return;
    }

    PRINTF("Enter color to set in palette:\n");
    uint64_t color = get_value();
    
    glb_palette[idx] = color;
    PRINTF("Writting at 0x%llx color 0x%llx\n", idx, color);
}

void crea_palet() {
    PRINTF("Enter index of palette (< %i):\n", NB_STD);
    uint64_t idx = get_value();

    if (idx >= NB_STD) {
        PRINTF("Index too big!\n");
        return;
    }
    
    PRINTF("Enter number of color in palette:\n");
    uint64_t sz = get_value();

    if (sz > MAX_PALETTE_SIZE) {
        PRINTF("Too Big!\n");
        return;
    }

    std_palette[idx] = malloc(sz * sizeof(uint64_t));

    PRINTF("[DEBUG] Palette allocated at %p\n", std_palette[idx]);
}

void destroy_palet() {
    PRINTF("Enter index of palette (< %i):\n", NB_STD);
    uint64_t idx = get_value();

    if (idx >= NB_STD) {
        PRINTF("Index too big!\n");
        return;
    }

    if (!std_palette[idx]) {
        PRINTF("Palette do not exist!\n");
        return;
    }

    free(std_palette[idx]);
    std_palette[idx] = NULL;
    PRINTF("Palette %li has been deletted.\n", idx);
}

static void menu(void)
{
    while (1) {
        PRINTF("Welcome to myApp! What would you like to do ?\n");
        PRINTF(" %u. Create global palet\n", GlobalPalet);
        PRINTF(" %u. Set value global palet\n", SetGlobalPalet);
        PRINTF(" %u. Create normal palet\n", CreatePalet);
        PRINTF(" %u. Destroy normal palet\n", DestroyPalet);
        PRINTF(" %u. Get the flag!\n", GetFlag);
        PRINTF(" %u. Exit this cool program\n", Exit);
        switch (get_action())
        {
            case GlobalPalet:
                global_palet();
                break;
            case SetGlobalPalet:
                set_glb_palet();
                break;
            case CreatePalet:
                crea_palet();
                break;
            case DestroyPalet:
                destroy_palet();
                break;
            case GetFlag:
	            get_flag();
                break;
            case Exit:
	            return;
        }

    }
}

int main(void)
{
    setup_serv(menu);
    return 0;
}
